<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treemap con Títulos de Licitaciones</title>
    <script src="https://cdn.jsdelivr.net/npm/d3plus@2"></script>
    <style>
        #chart {
            width: 100%;
            height: 600px;
        }
    </style>
</head>

<body>
    <h1 style="text-align: center;">Empresas con representación de servidores públicos</h1>
    <div id="chart"></div>
    <div id="detalleParticipaciones" style="position: relative;"></div>

    <script>

        // Cargar datos desde el archivo JSON
        fetch('data/data3.json')
            .then(response => response.json())
            .then(data => {
                // Transformar los datos para el treemap
                const transformedData = data.map((persona, personaIndex) => ({
                    empresa: persona.nombreEmpresa, // Primer nivel: Nombre de la empresa
                    rfc: persona.rfc,
                    participaciones: persona.participaciones,
                    datosGenerales: persona.datosGenerales,
                    datosEmpleoCargoComision: persona.datosEmpleoCargoComision,
                    value: persona.sistema6.length, // Tamaño basado en el número de elementos en sistema6_data
                    children: persona.sistema6.map((sistema, sistemaIndex) => ({
                        id: sistemaIndex, // ID único basado en el índice
                        tenderTitle: sistema.tender.title, // Usamos el título para los datos internos
                        buyer: sistema.buyer, // Comprador
                        tender: sistema.tender,
                        value: 1 // Valor fijo para cada licitación
                    }))
                }));

                // Crear el gráfico de treemap con drill down
                const visualization = new d3plus.Treemap()
                    .data(transformedData)
                    .groupBy(["empresa", "id"]) // Grupo por empresa y un ID único para no agrupar licitaciones
                    .sum("value") // Determina el tamaño de cada bloque
                    .select("#chart")
                    .label(function (d) {
                        // Mostrar nombre de la empresa en el primer nivel, y el título de la licitación en los siguientes niveles
                        return d["tenderTitle"] ? d["tenderTitle"] : d["empresa"];
                    })
                    .tooltipConfig({
                        title: function (d) {
                            return d["tenderTitle"] ? d["tenderTitle"] : d["empresa"] || "Empresa no disponible"; // Título principal: nombre de la empresa
                        },
                        tbody: function (d) {
                            if (d["children"] && d["children"].length > 0) {
                                // Si hay children disponibles, mostramos información de la licitación
                                return [
                                    ["Número de Licitaciones", d["value"] || "No disponible"],
                                    ["RFC", d["rfc"] || "No disponible"],
                                ];
                            } else {
                                // Si no hay children, mostramos solo el nombre de la empresa
                                const tender = d.tender || {}; // Tomamos el objeto tender
                                return [
                                    /* ["Monto", tender.value.amount || "No disponible"], */
                                    ["Comprador", d.buyer ? d.buyer.name || "No disponible" : "No disponible"],
                                    ["Título de Licitación", d.tenderTitle || "No disponible"],
                                    /* ["Descripción de la Licitación", tender.description || "No disponible"], */
                                    ["Fecha de Inicio de la Licitación", tender.tenderPeriod ? tender.tenderPeriod.startDate || "No disponible" : "No disponible"],
                                    ["Fecha de Finalización de la Licitación", tender.awardPeriod ? tender.awardPeriod.endDate || "No disponible" : "No disponible"],
                                    ["Método de Adquisición", tender.procurementMethod || "No disponible"],
                                    ["Comprador", tender.procuringEntity ? tender.procuringEntity.name || "No disponible" : "No disponible"],
                                    ["Estado del Proceso", tender.status || "No disponible"],
                                ];
                            }
                        }
                    })
                    .on("click", function (d) {
    console.log(d);

    // Verificar si tiene hijos
    if (d.children && d.children.length > 0) {
        // Mostrar el siguiente nivel
        visualization.config({ data: d.children }).render();
    } else {
        // Volver al nivel superior
        visualization.config({ data: transformedData }).render();
    }

    // Obtener el div donde se mostrarán los detalles de participaciones
    var detalleDiv = document.getElementById("detalleParticipaciones");

    // Limpiar el contenido anterior del div
    detalleDiv.innerHTML = "";

    // Verificar si hay participaciones en el nodo
    if (d.participaciones) {
        // Si es un objeto, convertirlo en un arreglo
        let participaciones = Array.isArray(d.participaciones) ? d.participaciones : [d.participaciones];

        // Crear una lista no ordenada
        var ul = document.createElement("ul");

        // Agregar los elementos de la lista con los datos de cada participación
        participaciones.forEach(function (participacion) {
            // Validar cada valor y asignar "No disponible" si es undefined
            var nombre = participacion.nombre || "No disponible";
            var primerApellido = participacion.primerApellido || "No disponible";
            var segundoApellido = participacion.segundoApellido || "No disponible";
            var nombreEmpresaParticipacion = participacion.nombreEmpresaParticipacion || "No disponible";
            var rfcParticipacion = participacion.rfcParticipacion || "No disponible";
            var porcentajeParticipacion = participacion.porcentajeParticipacion !== undefined ? participacion.porcentajeParticipacion : "No disponible";
            var recibeRemuneracion = participacion.recibeRemuneracion !== undefined ? (participacion.recibeRemuneracion ? 'Sí' : 'No') : "No disponible";
            var tipoParticipacion = participacion.tipoParticipacion || "No disponible";
            var sectorParticipacion = participacion.sectorParticipacion || "No disponible";

            // Crear el elemento <li> con saltos de línea y valores validados
            var li = document.createElement("li");
            li.innerHTML = `Nombre: ${nombre} ${primerApellido} ${segundoApellido}<br>
                Empresa: ${nombreEmpresaParticipacion}<br>
                RFC: ${rfcParticipacion}<br>
                Porcentaje: ${porcentajeParticipacion}%<br>
                Remuneración: ${recibeRemuneracion}<br>
                Tipo: ${tipoParticipacion}<br>
                Sector: ${sectorParticipacion}`;
            ul.appendChild(li);
        });

        // Agregar la lista al div
        detalleDiv.appendChild(ul);
    } 
})
                    .render();
            })
            .catch(error => console.error('Error al cargar los datos:', error));
    </script>
</body>

</html>
