<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empresas con representación de servidores públicos</title>
    <script src="https://cdn.jsdelivr.net/npm/d3plus@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>
        #chart {
            width: 100%;
            height: 600px;
        }

        #backButton {
            display: none;
            /* background-color: #713972;
            color: white; */
        }
    </style>
</head>

<body>
    <nav class="navbar bg-body-tertiary"
        style="background: transparent linear-gradient(230deg, #1C7CBF 0%, #1C7CBF 4%, #9F58E2 49%, #6D4061 100%) 0% 0% !important; z-index: 10;">
        <div class="container-fluid" style="max-width: 1700px !important">
            <a class="navbar-brand" href="https://www.plataformadigitalnacional.org/">
                <img src="./iconos/logo_pdn-transparente.svg" alt="Logo" height="32"
                    class="d-inline-block align-text-top">
            </a>
        </div>
    </nav>
    <div class="container mt-3 mb-5" style="max-width: 1700px !important">
        <div class="row text-center mx-auto">
            <div class="col-12">
                <h1 style="text-align: center;">Empresas con representación de servidores públicos</h1>
                <div id="chart"></div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <button id="backButton" type="button" class="btn btn-sm btn-primary float-end m-2">Regresar</button>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div id="detalleParticipaciones" style="position: relative;"></div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;  // Variable para almacenar los datos actuales del treemap
        // Cargar datos desde el archivo JSON
        fetch('data/data3.json')
            .then(response => response.json())
            .then(data => {
                // Transformar los datos para el treemap
                const colorBase = "#713972";  // Color base
                const transformedData = data.map((persona, personaIndex) => ({
                    empresa: persona.nombreEmpresa, // Primer nivel: Nombre de la empresa
                    rfc: persona.rfc,
                    participaciones: persona.participaciones,
                    datosGenerales: persona.datosGenerales,
                    datosEmpleoCargoComision: persona.datosEmpleoCargoComision,
                    value: persona.sistema6.length, // Tamaño basado en el número de elementos en sistema6_data
                    children: persona.sistema6.map((sistema, sistemaIndex) => ({
                        id: sistemaIndex, // ID único basado en el índice
                        tenderTitle: sistema.tender.title, // Usamos el título para los datos internos
                        buyer: sistema.buyer, // Comprador
                        tender: sistema.tender,
                        value: 1, // Valor fijo para cada licitación
                        isSupplier: sistema.parties && sistema.parties.some(party =>
                            Array.isArray(party.roles) && party.roles.includes('supplier')
                        )
                    }))
                }));
                console.log(transformedData)
                const backButton = document.getElementById('backButton');
                // Crear el gráfico de treemap con drill down
                const visualization = new d3plus.Treemap()
                    .data(transformedData)
                    .groupBy(["empresa", "id"]) // Grupo por empresa y un ID único para no agrupar licitaciones
                    .sum("value") // Determina el tamaño de cada bloque
                    .shapeConfig({
                        labelConfig: {
                            // Cambiar el texto mostrado en los cuadros
                            text: function (d) {
                                // Mostrar el nombre de la empresa en el primer nivel, o el título de la licitación en los niveles más bajos
                                let label = d["children"] && d["children"].length > 0
                                    ? d["empresa"] + "\nParticipaciones: " + d["value"]
                                    : d["tenderTitle"];

                                // Si es 'supplier', añadir la estrellita (★) al inicio
                                if (d.isSupplier) {
                                    label = "★\n" + label; // Colocar la estrella al inicio
                                }
                                return label;
                            }
                        }
                    })
                    .select("#chart")
                    .label(function (d) {
                        // Mostrar nombre de la empresa en el primer nivel, y el título de la licitación en los siguientes niveles
                        return d["tenderTitle"] ? d["tenderTitle"] : d["empresa"];

                    })
                    .tooltipConfig({
                        title: function (d) {
                            return d["tenderTitle"] ? d["tenderTitle"] : d["empresa"] || "Empresa no disponible"; // Título principal: nombre de la empresa
                        },
                        tbody: function (d) {
                            if (d["children"] && d["children"].length > 0) {
                                // Si hay children disponibles, mostramos información de la licitación
                                return [
                                    ["Número de participaciones", d["value"] || "No disponible"],
                                    ["RFC", d["rfc"] || "No disponible"],
                                ];
                            } else {
                                // Si no hay children, mostramos solo el nombre de la empresa
                                const tender = d.tender || {}; // Tomamos el objeto tender
                                return [
                                    /* ["Monto", tender.value.amount || "No disponible"], */
                                    ["Comprador", d.buyer ? d.buyer.name || "No disponible" : "No disponible"],
                                    ["Título de Licitación", d.tenderTitle || "No disponible"],
                                    /* ["Descripción de la Licitación", tender.description || "No disponible"], */
                                    ["Fecha de Inicio de la Licitación", tender.tenderPeriod ? tender.tenderPeriod.startDate || "No disponible" : "No disponible"],
                                    ["Fecha de Finalización de la Licitación", tender.awardPeriod ? tender.awardPeriod.endDate || "No disponible" : "No disponible"],
                                    ["Método de Adquisición", tender.procurementMethod || "No disponible"],
                                    ["Comprador", tender.procuringEntity ? tender.procuringEntity.name || "No disponible" : "No disponible"],
                                    ["Estado del Proceso", tender.status || "No disponible"],
                                ];
                            }
                        }
                    })
                    .on("click", function (d) {

                        // Verificar si tiene hijos
                        if (d.children && d.children.length > 0) {
                            currentData = transformedData; // Guardar la referencia del nivel padre
                            backButton.style.display = 'block'; // Mostrar el botón de regreso
                            // Mostrar el siguiente nivel
                            visualization.config({ data: d.children }).render();

                        } else {
                            // Volver al nivel superior
                            backButton.style.display = 'none';
                            visualization.config({ data: transformedData }).render();
                        }

                        // Obtener el div donde se mostrarán los detalles de participaciones
                        var detalleDiv = document.getElementById("detalleParticipaciones");

                        // Limpiar el contenido anterior del div
                        detalleDiv.innerHTML = "";

                        // Verificar si hay participaciones en el nodo
                        if (d.participaciones) {
                            // Si es un objeto, convertirlo en un arreglo
                            let participaciones = Array.isArray(d.participaciones) ? d.participaciones : [d.participaciones];

                            // Crear una lista no ordenada
                            var ul = document.createElement("ul");

                            // Agregar los elementos de la lista con los datos de cada participación
                            participaciones.forEach(function (participacion) {
                                // Validar cada valor y asignar "No disponible" si es undefined
                                var nombre = participacion.nombre || "No disponible";
                                var primerApellido = participacion.primerApellido || "No disponible";
                                var segundoApellido = participacion.segundoApellido || "No disponible";
                                var nombreEmpresaParticipacion = participacion.nombreEmpresaParticipacion || "No disponible";
                                var rfcParticipacion = participacion.rfcParticipacion || "No disponible";
                                var porcentajeParticipacion = participacion.porcentajeParticipacion !== undefined ? participacion.porcentajeParticipacion : "No disponible";
                                var recibeRemuneracion = participacion.recibeRemuneracion !== undefined ? (participacion.recibeRemuneracion ? 'Sí' : 'No') : "No disponible";
                                var tipoParticipacion = participacion.tipoParticipacion || "No disponible";
                                var sectorParticipacion = participacion.sectorParticipacion || "No disponible";

                                var empleoCargoComision = participacion.datosEmpleoCargoComision.empleoCargoComision || "No disponible";
                                var ente = participacion.datosEmpleoCargoComision.nombreEntePublico || "No disponible";
                                var fechaTomaPosesion = participacion.datosEmpleoCargoComision.fechaTomaPosesion || "No disponible";
                                var honorarios = participacion.datosEmpleoCargoComision.contratadoPorHonorarios !== undefined ? (participacion.datosEmpleoCargoComision.contratadoPorHonorarios ? 'Sí' : 'No') : "No disponible";

                                // Crear el elemento <li> con saltos de línea y valores validados
                                var li = document.createElement("li");
                                li.innerHTML = `Nombre: ${nombre} ${primerApellido} ${segundoApellido}<br>
                                    Empresa con participación: ${nombreEmpresaParticipacion}<br>
                                    RFC de la empresa con participación: ${rfcParticipacion}<br>
                                    Porcentaje de participación: ${porcentajeParticipacion}%<br>
                                    Remuneración en la participación: ${recibeRemuneracion}<br>
                                    Tipo de participación: ${tipoParticipacion}<br>
                                    Cargo: ${empleoCargoComision}<br>
                                    Ente público: ${ente}<br>
                                    Fecha de posesión: ${fechaTomaPosesion}<br>
                                    Contratado por honorarios: ${honorarios}<br>
                                    <br><br>
                                    `;

                                ul.appendChild(li);
                            });

                            // Agregar la lista al div
                            detalleDiv.appendChild(ul);
                        }
                    })
                    .render();
                // Añadir funcionalidad al botón de regreso
                backButton.addEventListener('click', function () {
                    if (currentData) {
                        // Volver al nivel padre
                        visualization.config({ data: currentData }).render();
                        backButton.style.display = 'none';  // Ocultar el botón de regreso
                        document.getElementById("detalleParticipaciones").innerHTML = ""; // Limpiar la sección de detalles
                    }
                });
            })
            .catch(error => console.error('Error al cargar los datos:', error));
    </script>
</body>

</html>
